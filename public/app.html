<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NoxiustDrive</title>
  <style>
    :root{
      --border: rgba(255,255,255,.14);
      --border2: rgba(255,255,255,.20);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --accent:#60a5fa;
      --panel: rgba(0,0,0,.18);
      --panel2: rgba(255,255,255,.05);
      --shadow: 0 24px 90px rgba(0,0,0,.70);
      --font: system-ui, -apple-system, "Segoe UI Variable", "Segoe UI", Roboto, Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow:hidden; font-family:var(--font); color:var(--text);
      background:
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65)),
        url("pictures/wallpapers/wallpaper2.jpeg");
      background-size:cover; background-position:center; background-repeat:no-repeat;
    }
    .window{position:relative; width:100vw; height:100vh; overflow:hidden;}
    .mica{
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(1200px 900px at 20% 15%, rgba(96,165,250,.10), transparent 55%),
        radial-gradient(900px 700px at 80% 20%, rgba(52,211,153,.06), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.55));
      backdrop-filter: blur(18px) saturate(140%);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
    }
    .ui{
      position:relative; z-index:1;
      width:100%; height:100%;
      display:flex; flex-direction:column;
      background: rgba(10,14,24,.55);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
    }
    .titlebar{
      height:46px; display:flex; align-items:center; justify-content:space-between;
      padding:0 12px; user-select:none;
      background: rgba(0,0,0,.34);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .title-left{display:flex; align-items:center; gap:10px;}
    .appicon{
      width:26px;height:26px;border-radius:8px;
      display:grid;place-items:center;
      background:rgba(96,165,250,.18);
      border:1px solid rgba(96,165,250,.28);
    }
    .apptitle{line-height:1.05}
    .apptitle b{display:block;font-size:.98rem}
    .apptitle span{display:block;font-size:.78rem;color:var(--muted)}
    .cmdbar{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; user-select:none;
      background: rgba(0,0,0,.22);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .btn{
      appearance:none; border:1px solid var(--border2);
      background: rgba(255,255,255,.07);
      color:var(--text);
      padding:8px 10px; border-radius:12px;
      cursor:pointer; font-size:.92rem;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover{background: rgba(255,255,255,.11); border-color: rgba(255,255,255,.26)}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .addrrow{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background: rgba(0,0,0,.14);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .addr{
      flex:1; min-width:0;
      display:flex; align-items:center; gap:6px;
      padding:8px 10px; border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      overflow:auto; scrollbar-width: thin;
      font-family: var(--mono);
      font-size:.9rem;
      color: rgba(255,255,255,.92);
    }
    .crumb{
      display:inline-flex; align-items:center; gap:6px;
      cursor:pointer; padding:3px 6px; border-radius:8px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .crumb:hover{background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.12)}
    .sep{color: rgba(255,255,255,.45)}
    .search{
      width:min(420px,45vw);
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
    }
    .search input{width:100%; border:0; outline:none; background:transparent; color:var(--text); font-size:.92rem}

    .body{flex:1; display:flex; min-height:0;}
    .left{
      width:310px; min-height:0;
      background: var(--panel);
      border-right:1px solid var(--border);
      padding:10px; display:flex; flex-direction:column; gap:10px;
    }
    .panehdr{
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: var(--panel2);
      color:var(--muted);
      font-size:.84rem; letter-spacing:.08em; text-transform:uppercase;
      user-select:none;
    }
    .tree{overflow:auto}
    .node{
      display:flex; align-items:center; gap:10px;
      padding:10px; border-radius:12px;
      cursor:pointer; user-select:none;
      border:1px solid transparent;
    }
    .node:hover{background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.14)}
    .icon{
      width:30px;height:30px;border-radius:10px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .label b{display:block; font-size:.94rem}
    .label span{display:block; font-size:.78rem; color:var(--muted); font-family:var(--mono)}
    .main{flex:1; min-width:0; padding:12px; display:flex; flex-direction:column; min-height:0;}
    .list{
      flex:1; min-height:0;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(0,0,0,.16);
      overflow:hidden; display:flex; flex-direction:column;
    }
    .listhead{
      display:grid;
      grid-template-columns: 1.55fr .75fr .85fr;
      padding:10px 12px;
      background: rgba(255,255,255,.05);
      border-bottom:1px solid var(--border);
      color:var(--muted);
      font-size:.82rem;
      user-select:none;
    }
    .rows{flex:1; overflow:auto; outline:none;}
    .row{
      display:grid;
      grid-template-columns: 1.55fr .75fr .85fr;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      align-items:center;
      cursor:pointer; user-select:none;
      border-left:3px solid transparent;
    }
    .row:hover{background: rgba(255,255,255,.07)}
    .row.selected{background: rgba(96,165,250,.18); border-left-color: rgba(96,165,250,.78)}
    .cellname{display:flex; align-items:center; gap:10px; min-width:0}
    .fileicon{
      width:30px;height:30px;border-radius:10px;
      display:grid; place-items:center;
      background: rgba(96,165,250,.16);
      border:1px solid rgba(96,165,250,.22);
      flex:0 0 auto;
    }
    .nametext{min-width:0}
    .nametext b{display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis}
    .nametext span{display:block; font-size:.8rem; color:var(--muted); font-family:var(--mono); overflow:hidden; white-space:nowrap; text-overflow:ellipsis}
    .type,.modified{color:var(--muted); font-size:.9rem}
    .details{
      width:360px; min-height:0;
      background: var(--panel);
      border-left:1px solid var(--border);
      padding:12px; display:flex; flex-direction:column; gap:10px;
    }
    .preview{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
      min-height:170px;
      display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden; user-select:none;
    }
    .preview img{
      max-width:100%; max-height:140px;
      border-radius:12px; border:1px solid rgba(255,255,255,.10);
    }
    .bigicon{font-size:52px}
    .preview small{
      position:absolute; bottom:10px; left:12px; right:12px;
      color: rgba(255,255,255,.78);
      font-size:.82rem;
      font-family:var(--mono);
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }
    .props{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
      overflow:auto;
      flex:1;
    }
    .props h3{margin:0 0 10px 0; font-size:.95rem}
    .kv{display:grid; grid-template-columns:1fr 1.2fr; gap:8px 10px; font-size:.88rem}
    .k{color:var(--muted)}
    .v{font-family:var(--mono); overflow:hidden; white-space:nowrap; text-overflow:ellipsis}
    .statusbar{
      height:34px;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 12px;
      color:var(--muted);
      font-size:.86rem;
      user-select:none;
      backdrop-filter: blur(10px);
    }
    .ctx{
      position:fixed; z-index:10000; display:none;
      min-width:170px;
      background: rgba(2,6,23,0.92);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:14px;
      box-shadow: 0 16px 50px rgba(0,0,0,0.65);
      padding:6px;
      backdrop-filter: blur(16px);
      user-select:none;
    }
    .ctx button{
      width:100%; border:0; background:transparent;
      color:var(--text);
      padding:10px 10px; border-radius:10px;
      cursor:pointer; text-align:left;
      font-size:.92rem;
    }
    .ctx button:hover{background: rgba(255,255,255,0.08)}
    .ctx button:disabled{opacity:.45; cursor:not-allowed}

    /* ===== View Toggle ===== */
    .viewtoggle { display:flex; gap:8px; align-items:center; }
    .pill {
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      font-size:.92rem;
    }
    .pill.active {
      background: rgba(96,165,250,.18);
      border-color: rgba(96,165,250,.35);
    }

    /* ===== Grid View ===== */
    .rows.grid {
      display:grid;
      gap:10px;
      padding:10px;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      align-content:start;
    }
    .tile {
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .08s ease;
    }
    .tile:hover { background: rgba(255,255,255,.06); transform: translateY(-1px); }
    .tile.selected { outline: 2px solid rgba(96,165,250,.65); }
    .thumb {
      height:120px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.04);
      position:relative;
    }
    .thumb img, .thumb video {
      max-width:100%;
      max-height:100%;
      border-radius:10px;
    }
    .thumb .emoji { font-size:44px; opacity:.95; }
    .tilemeta { padding:10px; }
    .tilemeta b {
      display:block;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .tilemeta span {
      display:block;
      margin-top:4px;
      font-size:.8rem;
      color: var(--muted);
      font-family: var(--mono);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }

    /* Lazy footer */
    .loadmore {
      padding:12px;
      text-align:center;
      color: var(--muted);
      border-top: 1px solid rgba(255,255,255,.06);
    }
  </style>
</head>

<body>
  <div class="window">
    <div class="mica"></div>

    <div class="ui" id="ui">
      <div class="titlebar">
        <div class="title-left">
          <div class="appicon">üóÇÔ∏è</div>
          <div class="apptitle">
            <b>NoxiustDrive</b>
            <span id="subtitle">Online</span>
          </div>
        </div>
      </div>

      <div class="cmdbar">
        <button class="btn" id="openBtn" disabled>üìÇ Open</button>
        <button class="btn" id="upBtn">‚¨ÜÔ∏è Up</button>
        <button class="btn" id="refreshBtn">üîÑ Refresh</button>

        <div style="flex:1"></div>

        <div class="viewtoggle">
          <div class="pill active" id="listViewBtn">‚ò∞ List</div>
          <div class="pill" id="gridViewBtn">‚ñ¶ Grid</div>
        </div>

        <div class="btn" style="cursor:default; opacity:.9;">üì° <span id="net">Ready</span></div>
      </div>

      <div class="addrrow">
        <div class="addr" id="addr"></div>
        <div class="search">üîé <input id="searchBox" placeholder="Search (filters list)"/></div>
      </div>

      <div class="body">
        <div class="left">
          <div class="panehdr"><span>This PC</span><span>Tree</span></div>
          <div class="tree" id="tree"></div>
        </div>

        <div class="main">
          <div class="list">
            <div class="listhead" id="listHead"><div>Name</div><div>Type</div><div>Date modified</div></div>
            <div class="rows" id="rows" tabindex="0"></div>
            <div class="loadmore" id="loadMore" style="display:none;">Loading more‚Ä¶</div>
          </div>
        </div>

        <div class="details">
          <div class="panehdr"><span>Details</span><span>Preview + Properties</span></div>
          <div class="preview" id="preview">
            <div class="bigicon">üóÇÔ∏è</div>
            <small>Select an item</small>
          </div>
          <div class="props">
            <h3>Properties</h3>
            <div class="kv" id="kv"></div>
          </div>
        </div>
      </div>

      <div class="statusbar">
        <div id="sbLeft">0 items</div>
        <div id="sbRight">Ready</div>
      </div>
    </div>
  </div>

  <div class="ctx" id="ctxMenu"><button id="ctxOpen" disabled>Open</button></div>

<script>
  const rowsEl = document.getElementById("rows");
  const searchBox = document.getElementById("searchBox");
  const openBtn = document.getElementById("openBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const upBtn = document.getElementById("upBtn");
  const addrEl = document.getElementById("addr");
  const tree = document.getElementById("tree");
  const preview = document.getElementById("preview");
  const kv = document.getElementById("kv");
  const sbLeft = document.getElementById("sbLeft");
  const sbRight = document.getElementById("sbRight");
  const net = document.getElementById("net");

  const listViewBtn = document.getElementById("listViewBtn");
  const gridViewBtn = document.getElementById("gridViewBtn");
  const loadMoreEl  = document.getElementById("loadMore");
  const listHead    = document.getElementById("listHead");

  const ctxMenu = document.getElementById("ctxMenu");
  const ctxOpen = document.getElementById("ctxOpen");

  const TOPS = [
    { key:"documents", name:"Documents", icon:"üìÑ" },
    { key:"music",     name:"Music",     icon:"üéµ" },
    { key:"pictures",  name:"Pictures",  icon:"üñºÔ∏è" },
    { key:"videos",    name:"Videos",    icon:"üé¨" },
  ];

  let INDEX = null;

  // Current folder items
  let items = [];

  // Render pool (filtered current folder)
  let renderPool = [];
  let selectedIndex = -1;

  // View + lazy settings
  let VIEW_MODE = localStorage.getItem("ND_VIEW") || "list"; // "list" | "grid"
  let RENDER_BATCH = 120;
  let renderCount = 0;
  let isRendering = false;

  function extLower(name){
    const i = (name||"").lastIndexOf(".");
    return i>=0 ? name.slice(i+1).toLowerCase() : "";
  }
  function isImageExt(ext){ return ["png","jpg","jpeg","webp","gif","bmp","svg"].includes(ext); }
  function isVideoExt(ext){ return ["mp4","webm","mkv","mov"].includes(ext); }
  function isAudioExt(ext){ return ["mp3","wav","flac","m4a","aac","ogg"].includes(ext); }

  function iconFor(item){
    if(item.kind === "folder") return "üìÅ";
    const t = (item.type || extLower(item.name) || "").toLowerCase();
    if(isImageExt(t)) return "üñºÔ∏è";
    if(isAudioExt(t)) return "üéµ";
    if(isVideoExt(t)) return "üé¨";
    if(t === "pdf") return "üìï";
    if(["txt","md","log","json","xml","yml","yaml"].includes(t)) return "üìÑ";
    return "üì¶";
  }

  function fmtBytes(n){
    if(!n) return "‚Äî";
    const u = ["B","KB","MB","GB","TB"];
    let i=0, x=n;
    while(x>=1024 && i<u.length-1){ x/=1024; i++; }
    return `${x.toFixed(i?1:0)} ${u[i]}`;
  }

  function fmtDate(ms){
    if(!ms) return "‚Äî";
    const d = new Date(ms);
    return d.toLocaleString();
  }

  function currentPath(){
    const p = new URLSearchParams(location.search).get("path") || "";
    return p.replace(/^\/+/, "").replace(/\/+$/, "");
  }

  function setPath(p){
    const url = new URL(location.href);
    if(p) url.searchParams.set("path", p);
    else url.searchParams.delete("path");
    history.pushState({}, "", url);
    load();
  }

  function buildCrumbs(pathStr){
    addrEl.innerHTML = "";
    const parts = pathStr ? pathStr.split("/") : [];
    const crumbs = [{ label: "This PC", path: "" }];

    let acc = "";
    for(const part of parts){
      acc = acc ? `${acc}/${part}` : part;
      crumbs.push({ label: part, path: acc });
    }

    crumbs.forEach((c, i)=>{
      const el = document.createElement("span");
      el.className = "crumb";
      el.textContent = c.label;
      el.onclick = ()=> setPath(c.path);
      addrEl.appendChild(el);

      if(i < crumbs.length - 1){
        const sep = document.createElement("span");
        sep.className = "sep";
        sep.textContent = ">";
        addrEl.appendChild(sep);
      }
    });
  }

  async function loadIndex(){
    const r = await fetch(`/_index.json?ts=${Date.now()}`, { cache: "no-store" });
    if(!r.ok) throw new Error(`Failed to load /_index.json (${r.status})`);
    return await r.json();
  }

  function nodeChildrenForPath(p){
    if(!INDEX) return [];

    if(!p){
      return TOPS.map(t => ({
        name: t.name,
        kind: "folder",
        size: 0,
        mtimeMs: INDEX.generatedAt || 0,
        relPath: t.key,
        url: `/${t.key}/`,
        children: INDEX.tree?.[t.key] || []
      }));
    }

    const parts = p.split("/").filter(Boolean);
    const root = parts.shift();
    let cur = { children: INDEX.tree?.[root] || [] };

    for(const part of parts){
      const next = (cur.children || []).find(x => x.kind === "folder" && x.name === part);
      if(!next) return [];
      cur = next;
    }

    const ch = (cur.children || []).map(x => ({
      ...x,
      url: x.url || (x.kind === "folder" ? `/${x.relPath}/` : `/${x.relPath}`),
      type: x.kind === "folder" ? "folder" : (extLower(x.name) || "file")
    }));

    ch.sort((a,b)=>{
      if(a.kind !== b.kind) return a.kind === "folder" ? -1 : 1;
      return a.name.localeCompare(b.name);
    });

    return ch;
  }

  function renderTree(){
    tree.innerHTML = "";
    for(const t of TOPS){
      const n = document.createElement("div");
      n.className = "node";
      n.innerHTML = `<div class="icon">${t.icon}</div>
        <div class="label"><b>${t.name}</b><span>/${t.key}/</span></div>`;
      n.onclick = ()=> setPath(t.key);
      tree.appendChild(n);
    }
  }

  function applyFilterToPool(){
    const q = (searchBox.value || "").trim().toLowerCase();
    const base = !q ? items : items.filter(x => (x.name||"").toLowerCase().includes(q));
    return base;
  }

  function setViewMode(mode){
    VIEW_MODE = mode;
    localStorage.setItem("ND_VIEW", mode);
    listViewBtn.classList.toggle("active", mode === "list");
    gridViewBtn.classList.toggle("active", mode === "grid");
    listHead.style.display = (mode === "list") ? "grid" : "none";
    rowsEl.classList.toggle("grid", mode === "grid");
    renderRows(true);
  }
  listViewBtn.onclick = ()=> setViewMode("list");
  gridViewBtn.onclick = ()=> setViewMode("grid");

  function renderRows(reset=false){
    if(reset){
      rowsEl.innerHTML = "";
      renderCount = 0;
      selectedIndex = -1;
      hideCtx();
    }

    renderPool = applyFilterToPool();
    sbLeft.textContent = `${renderPool.length} item${renderPool.length===1?"":"s"}`;

    if(renderPool.length === 0){
      loadMoreEl.style.display = "none";
      updateDetails(null);
      return;
    }

    renderNextBatch(true);
  }

  function highlightSelection(){
    const children = Array.from(rowsEl.children).filter(el => el.classList.contains("row") || el.classList.contains("tile"));
    children.forEach((el, i)=>{
      el.classList.toggle("selected", i === selectedIndex);
    });
    openBtn.disabled = (selectedIndex < 0);
    ctxOpen.disabled = (selectedIndex < 0);
  }

  function selectedItem(){
    if(selectedIndex < 0 || selectedIndex >= renderPool.length) return null;
    return renderPool[selectedIndex];
  }

  function updateDetails(it){
    if(!it){
      preview.innerHTML = `<div class="bigicon">üóÇÔ∏è</div><small>Select an item</small>`;
      kv.innerHTML = `
        <div class="k">Name</div><div class="v">‚Äî</div>
        <div class="k">Type</div><div class="v">‚Äî</div>
        <div class="k">Size</div><div class="v">‚Äî</div>
        <div class="k">Modified</div><div class="v">‚Äî</div>
        <div class="k">URL</div><div class="v">‚Äî</div>
      `;
      openBtn.disabled = true;
      ctxOpen.disabled = true;
      return;
    }

    const ext = extLower(it.name);
    const isImage = it.kind === "file" && isImageExt(ext);
    const isVideo = it.kind === "file" && isVideoExt(ext);
    const isAudio = it.kind === "file" && isAudioExt(ext);

    if(isImage){
      preview.innerHTML = `<img src="${it.url}" alt=""><small>${it.url}</small>`;
    } else if(isVideo){
      preview.innerHTML = `
        <video src="${it.url}" controls preload="metadata"
          style="width:100%;max-height:140px;border-radius:12px;border:1px solid rgba(255,255,255,.10)"></video>
        <small>${it.url}</small>
      `;
    } else if(isAudio){
      preview.innerHTML = `
        <audio src="${it.url}" controls preload="metadata" style="width:100%"></audio>
        <small>${it.url}</small>
      `;
    } else {
      preview.innerHTML = `<div class="bigicon">${iconFor(it)}</div><small>${it.url}</small>`;
    }

    kv.innerHTML = `
      <div class="k">Name</div><div class="v" title="${it.name}">${it.name}</div>
      <div class="k">Type</div><div class="v">${it.kind === "folder" ? "File folder" : (ext || "file")}</div>
      <div class="k">Size</div><div class="v">${it.kind === "folder" ? "‚Äî" : fmtBytes(it.size)}</div>
      <div class="k">Modified</div><div class="v">${fmtDate(it.mtimeMs)}</div>
      <div class="k">URL</div><div class="v" title="${it.url}">${it.url}</div>
    `;

    openBtn.disabled = false;
    ctxOpen.disabled = false;
  }

  function openSelected(){
    const it = selectedItem();
    if(!it) return;
    if(it.kind === "folder"){
      setPath(it.relPath.replace(/\/+$/, ""));
    } else {
      window.open(it.url, "_blank", "noopener");
    }
  }

  function renderNextBatch(first=false){
    if(isRendering) return;
    isRendering = true;

    const target = Math.min(renderPool.length, renderCount + RENDER_BATCH);
    loadMoreEl.style.display = (renderCount < renderPool.length) ? "block" : "none";

    const frag = document.createDocumentFragment();

    for(let idx = renderCount; idx < target; idx++){
      const e = renderPool[idx];

      if(VIEW_MODE === "list"){
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="cellname">
            <div class="fileicon">${iconFor(e)}</div>
            <div class="nametext">
              <b>${e.name}</b>
              <span>${e.url}</span>
            </div>
          </div>
          <div class="type">${e.kind === "folder" ? "File folder" : (extLower(e.name) || "file")}</div>
          <div class="modified">${fmtDate(e.mtimeMs)}</div>
        `;

        row.addEventListener("click", ()=>{
          selectedIndex = idx;
          hideCtx();
          highlightSelection();
          updateDetails(selectedItem());
        });
        row.addEventListener("dblclick", ()=>{
          selectedIndex = idx;
          hideCtx();
          highlightSelection();
          updateDetails(selectedItem());
          openSelected();
        });
        row.addEventListener("contextmenu", (ev)=>{
          ev.preventDefault();
          selectedIndex = idx;
          highlightSelection();
          updateDetails(selectedItem());
          showCtx(ev.clientX, ev.clientY);
        });

        frag.appendChild(row);
      } else {
        const tile = document.createElement("div");
        tile.className = "tile";

        const ext = extLower(e.name);
        const isImg = e.kind==="file" && isImageExt(ext);
        const isVid = e.kind==="file" && isVideoExt(ext);

        // NOTE: video thumbs can be heavy. If you want faster grid, change isVid handling to emoji.
        let thumbHTML = `<div class="emoji">${iconFor(e)}</div>`;
        if(isImg){
          thumbHTML = `<img src="${e.url}" loading="lazy" alt="">`;
        } else if(isVid){
          thumbHTML = `<video src="${e.url}" muted preload="metadata"></video>`;
        }

        tile.innerHTML = `
          <div class="thumb">${thumbHTML}</div>
          <div class="tilemeta">
            <b title="${e.name}">${e.name}</b>
            <span title="${e.url}">${e.url}</span>
          </div>
        `;

        tile.addEventListener("click", ()=>{
          selectedIndex = idx;
          hideCtx();
          highlightSelection();
          updateDetails(selectedItem());
        });
        tile.addEventListener("dblclick", ()=>{
          selectedIndex = idx;
          hideCtx();
          highlightSelection();
          updateDetails(selectedItem());
          openSelected();
        });
        tile.addEventListener("contextmenu", (ev)=>{
          ev.preventDefault();
          selectedIndex = idx;
          highlightSelection();
          updateDetails(selectedItem());
          showCtx(ev.clientX, ev.clientY);
        });

        frag.appendChild(tile);
      }
    }

    rowsEl.appendChild(frag);

    // first render: auto-select first item
    if(first){
      if(selectedIndex < 0 && renderPool.length > 0) selectedIndex = 0;
      highlightSelection();
      updateDetails(selectedItem());
    } else {
      highlightSelection();
    }

    renderCount = target;
    loadMoreEl.style.display = (renderCount < renderPool.length) ? "block" : "none";
    isRendering = false;
  }

  function showCtx(x,y){
    ctxMenu.style.display = "block";
    const pad=8;
    const w=ctxMenu.offsetWidth, h=ctxMenu.offsetHeight;
    ctxMenu.style.left = Math.max(pad, Math.min(x, innerWidth-w-pad)) + "px";
    ctxMenu.style.top  = Math.max(pad, Math.min(y, innerHeight-h-pad)) + "px";
    ctxOpen.disabled = !selectedItem();
  }
  function hideCtx(){ ctxMenu.style.display = "none"; }
  ctxOpen.onclick = ()=>{ hideCtx(); openSelected(); };
  document.addEventListener("click", (ev)=>{ if(!ev.target.closest(".ctx")) hideCtx(); });
  window.addEventListener("resize", hideCtx);

  // Lazy loading: when near bottom, render next batch
  rowsEl.addEventListener("scroll", ()=>{
    const nearBottom = rowsEl.scrollTop + rowsEl.clientHeight >= rowsEl.scrollHeight - 240;
    if(nearBottom && renderCount < renderPool.length){
      renderNextBatch(false);
    }
  });

  // Keyboard navigation (works in list/grid)
  rowsEl.addEventListener("keydown", (ev)=>{
    if(renderPool.length === 0) return;
    if(ev.key === "ArrowDown"){
      ev.preventDefault();
      selectedIndex = Math.min(renderPool.length-1, selectedIndex + 1);
      // ensure selected is rendered
      while(renderCount <= selectedIndex && renderCount < renderPool.length) renderNextBatch(false);
      highlightSelection();
      updateDetails(selectedItem());
    } else if(ev.key === "ArrowUp"){
      ev.preventDefault();
      selectedIndex = Math.max(0, selectedIndex - 1);
      highlightSelection();
      updateDetails(selectedItem());
    } else if(ev.key === "Enter"){
      ev.preventDefault();
      openSelected();
    }
  });

  // Buttons
  openBtn.onclick = openSelected;
  refreshBtn.onclick = load;

  upBtn.onclick = ()=>{
    const p = currentPath();
    if(!p) return;
    const parts = p.split("/").filter(Boolean);
    parts.pop();
    setPath(parts.join("/"));
  };

  searchBox.addEventListener("input", ()=>{
    renderRows(true);
  });

  window.addEventListener("popstate", load);

  async function load(){
    hideCtx();
    net.textContent = "Loading...";
    sbRight.textContent = "Loading...";
    selectedIndex = -1;

    const p = currentPath();
    buildCrumbs(p);

    try{
      INDEX = await loadIndex();
      items = nodeChildrenForPath(p);
      renderTree();
      renderRows(true);
      net.textContent = "OK";
      sbRight.textContent = "Ready";
    } catch(e){
      items = [];
      renderTree();
      renderRows(true);
      net.textContent = "Error";
      sbRight.textContent = String(e);
    }
  }

  // Initialize view mode then load
  setViewMode(VIEW_MODE);
  load();
</script>
</body>
</html>
