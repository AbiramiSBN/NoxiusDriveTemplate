<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NoxiustDrive</title>
  <style>
    :root{
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.22);
      --panel: rgba(14,16,24,.52);
      --panel2: rgba(10,12,18,.42);
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.10);
      --accent: #60a5fa;
      --accent2: rgba(96,165,250,.24);
      --shadow: 0 24px 90px rgba(0,0,0,.70);
      --font: system-ui, -apple-system, "Segoe UI Variable", "Segoe UI", Roboto, Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --r12: 12px;
      --r14: 14px;
      --r16: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow:hidden; font-family:var(--font); color:var(--text);
      background:
        linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.70)),
        url("pictures/wallpapers/wallpaper2.jpeg");
      background-size:cover; background-position:center; background-repeat:no-repeat;
    }

    /* ===== Lock Screen ===== */
    .lock{
      position:fixed; inset:0; z-index:99999;
      display:flex; align-items:center; justify-content:center;
      background:
        linear-gradient(180deg, rgba(0,0,0,.50), rgba(0,0,0,.75)),
        url("pictures/wallpapers/wallpaper.jpeg");
      background-size:cover; background-position:center;
    }
    .lock::before{
      content:"";
      position:absolute; inset:0;
      backdrop-filter: blur(18px) saturate(140%);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
    }
    .lockcard{
      position:relative;
      width:min(520px, 92vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(10,12,18,.48);
      box-shadow: 0 40px 120px rgba(0,0,0,.75);
      padding: 22px 22px 18px;
    }
    .locktop{
      display:flex; align-items:center; gap:14px;
      padding-bottom: 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 14px;
    }
    .avatar{
      width:54px; height:54px; border-radius: 18px;
      display:grid; place-items:center;
      background: rgba(96,165,250,.20);
      border:1px solid rgba(96,165,250,.30);
      font-size: 26px;
    }
    .locktitle b{display:block; font-size:1.15rem}
    .locktitle span{display:block; color:var(--muted); font-size:.9rem}
    .lockform{display:flex; gap:10px; margin-top: 14px}
    .inp{
      flex:1;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding: 12px 12px;
      color: var(--text);
      outline:none;
      font-size: 1rem;
    }
    .inp::placeholder{color: rgba(255,255,255,.45)}
    .lockbtn{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 12px 14px;
      cursor:pointer;
      font-weight: 600;
    }
    .lockbtn:hover{background: rgba(255,255,255,.14)}
    .lockmsg{
      margin-top: 10px;
      color: rgba(255,255,255,.78);
      font-size: .9rem;
      min-height: 1.1em;
    }

    /* ===== App Shell ===== */
    .window{position:relative; width:100vw; height:100vh; overflow:hidden;}
    .mica{
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(1200px 900px at 20% 15%, rgba(96,165,250,.10), transparent 55%),
        radial-gradient(900px 700px at 85% 25%, rgba(34,197,94,.06), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.60));
      backdrop-filter: blur(16px) saturate(135%);
      -webkit-backdrop-filter: blur(16px) saturate(135%);
    }
    .ui{
      position:relative; z-index:1;
      width:100%; height:100%;
      display:flex; flex-direction:column;
      background: rgba(10,14,24,.56);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
    }

    /* ===== Top Bar (Dolphin/Nautilus-ish) ===== */
    .topbar{
      height:52px;
      display:flex; align-items:center; gap:10px;
      padding: 0 12px;
      background: rgba(0,0,0,.28);
      border-bottom: 1px solid var(--stroke);
      backdrop-filter: blur(12px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding-right: 10px;
      border-right: 1px solid rgba(255,255,255,.10);
      margin-right: 2px;
    }
    .appicon{
      width:30px;height:30px;border-radius:10px;
      display:grid; place-items:center;
      background: rgba(96,165,250,.18);
      border:1px solid rgba(96,165,250,.30);
      font-size: 16px;
    }
    .brand b{font-size:1rem; letter-spacing:.2px}
    .brand span{display:block; color:var(--muted2); font-size:.78rem; margin-top:2px}

    .toolbtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      font-size: .95rem;
      user-select:none;
    }
    .toolbtn:hover{background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22)}
    .toolbtn:disabled{opacity:.45; cursor:not-allowed}
    .toolbtn.slim{padding:9px 9px}
    .spacer{flex:1}

    .pathbar{
      flex: 1;
      min-width: 240px;
      display:flex; align-items:center; gap:6px;
      padding: 9px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      overflow:auto;
      scrollbar-width: thin;
      user-select:none;
    }
    .crumb{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 8px;
      border-radius: 12px;
      border:1px solid transparent;
      cursor:pointer;
      white-space:nowrap;
      font-family: var(--mono);
      font-size: .88rem;
      color: rgba(255,255,255,.90);
    }
    .crumb:hover{background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.14)}
    .sep{color: rgba(255,255,255,.45)}

    .search{
      width: min(420px, 34vw);
      display:flex; align-items:center; gap:8px;
      padding: 9px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    .search input{
      width:100%;
      border:0; outline:none;
      background:transparent;
      color: var(--text);
      font-size: .95rem;
    }

    .toggle{
      display:flex; gap:6px; align-items:center;
      padding: 4px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      user-select:none;
    }
    .pill{
      padding: 7px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: .9rem;
      border:1px solid transparent;
      color: rgba(255,255,255,.86);
    }
    .pill:hover{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10)}
    .pill.active{
      background: rgba(96,165,250,.20);
      border-color: rgba(96,165,250,.28);
      color: rgba(255,255,255,.95);
    }

    /* ===== Main Layout ===== */
    .body{flex:1; display:flex; min-height:0;}
    .sidebar{
      width: 320px; min-height:0;
      background: rgba(0,0,0,.18);
      border-right: 1px solid var(--stroke);
      padding: 12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .panehdr{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: .84rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      user-select:none;
    }
    .places{overflow:auto}
    .place{
      display:flex; align-items:center; gap:12px;
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      user-select:none;
      border:1px solid transparent;
    }
    .place:hover{background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.12)}
    .place.active{background: rgba(96,165,250,.16); border-color: rgba(96,165,250,.22)}
    .picon{
      width: 34px; height: 34px; border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .plabel b{display:block; font-size:.98rem}
    .plabel span{display:block; font-size:.78rem; color: var(--muted2); font-family: var(--mono)}

    .content{
      flex:1; min-width:0; min-height:0;
      display:flex; flex-direction:column;
      padding: 12px;
      gap: 12px;
    }
    .frame{
      flex:1; min-height:0;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      background: rgba(0,0,0,.16);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .listhead{
      display:grid;
      grid-template-columns: 1.55fr .75fr .85fr;
      padding: 10px 12px;
      color: var(--muted);
      font-size: .82rem;
      background: rgba(255,255,255,.05);
      border-bottom: 1px solid rgba(255,255,255,.10);
      user-select:none;
    }

    .rows{
      flex:1; min-height:0;
      overflow:auto;
      outline:none;
      position:relative;
    }
    .row{
      display:grid;
      grid-template-columns: 1.55fr .75fr .85fr;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      align-items:center;
      cursor:pointer;
      user-select:none;
      border-left: 3px solid transparent;
    }
    .row:hover{background: rgba(255,255,255,.07)}
    .row.selected{
      background: rgba(96,165,250,.18);
      border-left-color: rgba(96,165,250,.78);
    }
    .cellname{display:flex; align-items:center; gap:10px; min-width:0}
    .fileicon{
      width: 32px; height: 32px; border-radius: 12px;
      display:grid; place-items:center;
      background: rgba(96,165,250,.16);
      border: 1px solid rgba(96,165,250,.22);
      flex:0 0 auto;
    }
    .nametext{min-width:0}
    .nametext b{display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis}
    .nametext span{
      display:block;
      font-size:.8rem;
      color: var(--muted2);
      font-family: var(--mono);
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }
    .type,.modified{color: var(--muted); font-size:.9rem}

    /* ===== Grid View ===== */
    .rows.grid{
      display:grid;
      gap:10px;
      padding:10px;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      align-content:start;
    }
    .tile{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius: 18px;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .08s ease;
    }
    .tile:hover{background: rgba(255,255,255,.06); transform: translateY(-1px)}
    .tile.selected{outline: 2px solid rgba(96,165,250,.65)}
    .thumb{
      height: 120px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.04);
      position:relative;
    }
    .thumb img, .thumb video{
      max-width:100%;
      max-height:100%;
      border-radius: 14px;
    }
    .thumb .emoji{font-size:44px; opacity:.95}
    .tilemeta{padding: 10px 12px}
    .tilemeta b{
      display:block;
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
      font-size:.95rem;
    }
    .tilemeta span{
      display:block;
      margin-top:4px;
      font-size:.78rem;
      color: var(--muted2);
      font-family: var(--mono);
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }

    .details{
      width: 380px; min-height:0;
      background: rgba(0,0,0,.18);
      border-left: 1px solid var(--stroke);
      padding: 12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .preview{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding: 12px;
      min-height: 190px;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .preview img{
      max-width:100%;
      max-height: 150px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
    }
    .preview small{
      position:absolute; bottom:10px; left:12px; right:12px;
      color: rgba(255,255,255,.78);
      font-size: .82rem;
      font-family: var(--mono);
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }
    .bigicon{font-size: 56px}
    .props{
      flex:1; min-height:0;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding: 12px;
      overflow:auto;
    }
    .props h3{margin:0 0 10px 0; font-size: .98rem}
    .kv{
      display:grid;
      grid-template-columns: 1fr 1.3fr;
      gap: 8px 10px;
      font-size: .88rem;
    }
    .k{color: var(--muted)}
    .v{
      font-family: var(--mono);
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }

    .statusbar{
      height: 34px;
      border-top: 1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:space-between;
      padding: 0 12px;
      color: var(--muted);
      font-size: .86rem;
      user-select:none;
      backdrop-filter: blur(10px);
    }

    .loadmore{
      padding: 12px;
      text-align:center;
      color: var(--muted2);
      border-top: 1px solid rgba(255,255,255,.06);
    }

    .ctx{
      position:fixed; z-index:10000; display:none;
      min-width: 170px;
      background: rgba(2,6,23,0.92);
      border:1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      box-shadow: 0 16px 50px rgba(0,0,0,0.65);
      padding: 6px;
      backdrop-filter: blur(16px);
      user-select:none;
    }
    .ctx button{
      width:100%;
      border:0; background:transparent;
      color: var(--text);
      padding: 10px 10px;
      border-radius: 12px;
      cursor:pointer;
      text-align:left;
      font-size: .92rem;
    }
    .ctx button:hover{background: rgba(255,255,255,0.08)}
    .ctx button:disabled{opacity:.45; cursor:not-allowed}
  </style>
</head>

<body>
  <!-- Lock (client-side) -->
  <div class="lock" id="lock" style="display:none;">
    <div class="lockcard">
      <div class="locktop">
        <div class="avatar">üîí</div>
        <div class="locktitle">
          <b>NoxiustDrive</b>
          <span id="lockHint">Enter to unlock</span>
        </div>
      </div>
      <div class="lockform">
        <input class="inp" id="lockPass" type="password" placeholder="Password" />
        <button class="lockbtn" id="unlockBtn">Unlock</button>
      </div>
      <div class="lockmsg" id="lockMsg"></div>
    </div>
  </div>

  <div class="window">
    <div class="mica"></div>

    <div class="ui" id="ui">
      <div class="topbar">
        <div class="brand">
          <div class="appicon">üóÇÔ∏è</div>
          <div>
            <b>NoxiustDrive</b>
            <span id="subtitle">Ready</span>
          </div>
        </div>

        <button class="toolbtn slim" id="backBtn" title="Back">‚¨ÖÔ∏è</button>
        <button class="toolbtn slim" id="fwdBtn" title="Forward">‚û°Ô∏è</button>
        <button class="toolbtn slim" id="upBtn" title="Up">‚¨ÜÔ∏è</button>
        <button class="toolbtn slim" id="refreshBtn" title="Refresh">üîÑ</button>

        <div class="pathbar" id="addr"></div>

        <div class="search">üîé <input id="searchBox" placeholder="Search"/></div>

        <div class="toggle" aria-label="View">
          <div class="pill" id="listViewBtn">List</div>
          <div class="pill" id="gridViewBtn">Grid</div>
        </div>

        <button class="toolbtn" id="openBtn" disabled>üìÇ Open</button>
        <button class="toolbtn" id="logoutBtn" title="Lock">üîí Logout</button>

        <div class="toolbtn" style="cursor:default; opacity:.92;">üì° <span id="net">OK</span></div>
      </div>

      <div class="body">
        <div class="sidebar">
          <div class="panehdr"><span>Places</span><span>This PC</span></div>
          <div class="places" id="places"></div>
        </div>

        <div class="content">
          <div class="frame">
            <div class="listhead" id="listHead"><div>Name</div><div>Type</div><div>Date modified</div></div>
            <div class="rows" id="rows" tabindex="0"></div>
            <div class="loadmore" id="loadMore" style="display:none;">Loading more‚Ä¶</div>
          </div>
        </div>

        <div class="details">
          <div class="panehdr"><span>Details</span><span>Preview</span></div>
          <div class="preview" id="preview">
            <div class="bigicon">üóÇÔ∏è</div>
            <small>Select an item</small>
          </div>
          <div class="props">
            <h3>Properties</h3>
            <div class="kv" id="kv"></div>
          </div>
        </div>
      </div>

      <div class="statusbar">
        <div id="sbLeft">0 items</div>
        <div id="sbRight">Ready</div>
      </div>
    </div>
  </div>

  <div class="ctx" id="ctxMenu"><button id="ctxOpen" disabled>Open</button></div>

<script>
  // ===== DOM =====
  const rowsEl = document.getElementById("rows");
  const searchBox = document.getElementById("searchBox");
  const openBtn = document.getElementById("openBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const upBtn = document.getElementById("upBtn");
  const backBtn = document.getElementById("backBtn");
  const fwdBtn = document.getElementById("fwdBtn");
  const addrEl = document.getElementById("addr");
  const placesEl = document.getElementById("places");
  const preview = document.getElementById("preview");
  const kv = document.getElementById("kv");
  const sbLeft = document.getElementById("sbLeft");
  const sbRight = document.getElementById("sbRight");
  const net = document.getElementById("net");
  const subtitle = document.getElementById("subtitle");

  const listViewBtn = document.getElementById("listViewBtn");
  const gridViewBtn = document.getElementById("gridViewBtn");
  const loadMoreEl  = document.getElementById("loadMore");
  const listHead    = document.getElementById("listHead");

  const ctxMenu = document.getElementById("ctxMenu");
  const ctxOpen = document.getElementById("ctxOpen");

  const logoutBtn = document.getElementById("logoutBtn");
  const lock = document.getElementById("lock");
  const lockPass = document.getElementById("lockPass");
  const unlockBtn = document.getElementById("unlockBtn");
  const lockMsg = document.getElementById("lockMsg");
  const lockHint = document.getElementById("lockHint");

  // ===== Places =====
  const TOPS = [
    { key:"documents", name:"Documents", icon:"üìÑ" },
    { key:"music",     name:"Music",     icon:"üéµ" },
    { key:"pictures",  name:"Pictures",  icon:"üñºÔ∏è" },
    { key:"videos",    name:"Videos",    icon:"üé¨" },
  ];

  // ===== State =====
  let INDEX = null;
  let items = [];
  let renderPool = [];
  let selectedIndex = -1;

  let VIEW_MODE = localStorage.getItem("ND_VIEW") || "list"; // list|grid
  let RENDER_BATCH = 120;
  let renderCount = 0;
  let isRendering = false;

  // Client-side lock (UI only)
  const LOCK_KEY = "ND_LOCK_HASH_V1"; // store sha256(pass) here
  let lockHash = localStorage.getItem(LOCK_KEY) || null;

  // ===== Utils =====
  function extLower(name){
    const i = (name||"").lastIndexOf(".");
    return i>=0 ? name.slice(i+1).toLowerCase() : "";
  }
  function isImageExt(ext){ return ["png","jpg","jpeg","webp","gif","bmp","svg"].includes(ext); }
  function isVideoExt(ext){ return ["mp4","webm","mkv","mov"].includes(ext); }
  function isAudioExt(ext){ return ["mp3","wav","flac","m4a","aac","ogg"].includes(ext); }

  function iconFor(item){
    if(item.kind === "folder") return "üìÅ";
    const t = extLower(item.name);
    if(isImageExt(t)) return "üñºÔ∏è";
    if(isAudioExt(t)) return "üéµ";
    if(isVideoExt(t)) return "üé¨";
    if(t === "pdf") return "üìï";
    if(["txt","md","log","json","xml","yml","yaml"].includes(t)) return "üìÑ";
    return "üì¶";
  }

  function fmtBytes(n){
    if(!n) return "‚Äî";
    const u = ["B","KB","MB","GB","TB"];
    let i=0, x=n;
    while(x>=1024 && i<u.length-1){ x/=1024; i++; }
    return `${x.toFixed(i?1:0)} ${u[i]}`;
  }
  function fmtDate(ms){
    if(!ms) return "‚Äî";
    return new Date(ms).toLocaleString();
  }

  function currentPath(){
    const p = new URLSearchParams(location.search).get("path") || "";
    return p.replace(/^\/+/, "").replace(/\/+$/, "");
  }
  function setPath(p){
    const url = new URL(location.href);
    if(p) url.searchParams.set("path", p);
    else url.searchParams.delete("path");
    history.pushState({}, "", url);
    load();
  }

  function buildCrumbs(pathStr){
    addrEl.innerHTML = "";
    const parts = pathStr ? pathStr.split("/") : [];
    const crumbs = [{ label: "This PC", path: "" }];
    let acc = "";
    for(const part of parts){
      acc = acc ? `${acc}/${part}` : part;
      crumbs.push({ label: part, path: acc });
    }
    crumbs.forEach((c, i)=>{
      const el = document.createElement("span");
      el.className = "crumb";
      el.textContent = c.label;
      el.onclick = ()=> setPath(c.path);
      addrEl.appendChild(el);
      if(i < crumbs.length - 1){
        const sep = document.createElement("span");
        sep.className = "sep";
        sep.textContent = "‚Ä∫";
        addrEl.appendChild(sep);
      }
    });
  }

  async function loadIndex(){
    const r = await fetch(`/_index.json?ts=${Date.now()}`, { cache: "no-store" });
    if(!r.ok) throw new Error(`Failed to load /_index.json (${r.status})`);
    return await r.json();
  }

  function nodeChildrenForPath(p){
    if(!INDEX) return [];
    if(!p){
      return TOPS.map(t => ({
        name: t.name,
        kind: "folder",
        size: 0,
        mtimeMs: INDEX.generatedAt || 0,
        relPath: t.key,
        url: `/${t.key}/`,
        children: INDEX.tree?.[t.key] || []
      }));
    }

    const parts = p.split("/").filter(Boolean);
    const root = parts.shift();
    let cur = { children: INDEX.tree?.[root] || [] };

    for(const part of parts){
      const next = (cur.children || []).find(x => x.kind === "folder" && x.name === part);
      if(!next) return [];
      cur = next;
    }

    const ch = (cur.children || []).map(x => ({
      ...x,
      url: x.url || (x.kind === "folder" ? `/${x.relPath}/` : `/${x.relPath}`)
    }));

    ch.sort((a,b)=>{
      if(a.kind !== b.kind) return a.kind === "folder" ? -1 : 1;
      return a.name.localeCompare(b.name);
    });

    return ch;
  }

  function renderPlaces(){
    const p = currentPath();
    const root = p.split("/")[0] || "";
    placesEl.innerHTML = "";
    for(const t of TOPS){
      const el = document.createElement("div");
      el.className = "place" + (root === t.key ? " active" : "");
      el.innerHTML = `
        <div class="picon">${t.icon}</div>
        <div class="plabel">
          <b>${t.name}</b>
          <span>/${t.key}/</span>
        </div>
      `;
      el.onclick = ()=> setPath(t.key);
      placesEl.appendChild(el);
    }
  }

  function applyFilterToPool(){
    const q = (searchBox.value || "").trim().toLowerCase();
    return !q ? items : items.filter(x => (x.name||"").toLowerCase().includes(q));
  }

  function setViewMode(mode){
    VIEW_MODE = mode;
    localStorage.setItem("ND_VIEW", mode);
    listViewBtn.classList.toggle("active", mode === "list");
    gridViewBtn.classList.toggle("active", mode === "grid");
    listHead.style.display = (mode === "list") ? "grid" : "none";
    rowsEl.classList.toggle("grid", mode === "grid");
    renderRows(true);
  }

  function renderRows(reset=false){
    if(reset){
      rowsEl.innerHTML = "";
      renderCount = 0;
      selectedIndex = -1;
      hideCtx();
    }

    renderPool = applyFilterToPool();
    sbLeft.textContent = `${renderPool.length} item${renderPool.length===1?"":"s"}`;

    if(renderPool.length === 0){
      loadMoreEl.style.display = "none";
      updateDetails(null);
      openBtn.disabled = true;
      ctxOpen.disabled = true;
      return;
    }

    renderNextBatch(true);
  }

  function highlightSelection(){
    const children = Array.from(rowsEl.children).filter(el => el.classList.contains("row") || el.classList.contains("tile"));
    children.forEach((el, i)=> el.classList.toggle("selected", i === selectedIndex));
    const has = !!selectedItem();
    openBtn.disabled = !has;
    ctxOpen.disabled = !has;
  }

  function selectedItem(){
    if(selectedIndex < 0 || selectedIndex >= renderPool.length) return null;
    return renderPool[selectedIndex];
  }

  function updateDetails(it){
    if(!it){
      preview.innerHTML = `<div class="bigicon">üóÇÔ∏è</div><small>Select an item</small>`;
      kv.innerHTML = `
        <div class="k">Name</div><div class="v">‚Äî</div>
        <div class="k">Type</div><div class="v">‚Äî</div>
        <div class="k">Size</div><div class="v">‚Äî</div>
        <div class="k">Modified</div><div class="v">‚Äî</div>
        <div class="k">URL</div><div class="v">‚Äî</div>
      `;
      return;
    }

    const ext = extLower(it.name);
    const isImg = it.kind === "file" && isImageExt(ext);
    const isVid = it.kind === "file" && isVideoExt(ext);
    const isAud = it.kind === "file" && isAudioExt(ext);

    if(isImg){
      preview.innerHTML = `<img src="${it.url}" alt=""><small>${it.url}</small>`;
    } else if(isVid){
      preview.innerHTML = `
        <video src="${it.url}" controls preload="metadata"
          style="width:100%;max-height:150px;border-radius:14px;border:1px solid rgba(255,255,255,.10)"></video>
        <small>${it.url}</small>
      `;
    } else if(isAud){
      preview.innerHTML = `
        <audio src="${it.url}" controls preload="metadata" style="width:100%"></audio>
        <small>${it.url}</small>
      `;
    } else {
      preview.innerHTML = `<div class="bigicon">${iconFor(it)}</div><small>${it.url}</small>`;
    }

    kv.innerHTML = `
      <div class="k">Name</div><div class="v" title="${it.name}">${it.name}</div>
      <div class="k">Type</div><div class="v">${it.kind === "folder" ? "Folder" : (ext || "file")}</div>
      <div class="k">Size</div><div class="v">${it.kind === "folder" ? "‚Äî" : fmtBytes(it.size)}</div>
      <div class="k">Modified</div><div class="v">${fmtDate(it.mtimeMs)}</div>
      <div class="k">URL</div><div class="v" title="${it.url}">${it.url}</div>
    `;
  }

  function openSelected(){
    const it = selectedItem();
    if(!it) return;
    if(it.kind === "folder"){
      setPath(it.relPath.replace(/\/+$/, ""));
    } else {
      window.open(it.url, "_blank", "noopener");
    }
  }

  function renderNextBatch(first=false){
    if(isRendering) return;
    isRendering = true;

    const target = Math.min(renderPool.length, renderCount + RENDER_BATCH);
    loadMoreEl.style.display = (renderCount < renderPool.length) ? "block" : "none";

    const frag = document.createDocumentFragment();

    for(let idx = renderCount; idx < target; idx++){
      const e = renderPool[idx];

      if(VIEW_MODE === "list"){
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="cellname">
            <div class="fileicon">${iconFor(e)}</div>
            <div class="nametext">
              <b>${e.name}</b>
              <span>${e.url}</span>
            </div>
          </div>
          <div class="type">${e.kind === "folder" ? "Folder" : (extLower(e.name) || "file")}</div>
          <div class="modified">${fmtDate(e.mtimeMs)}</div>
        `;

        row.addEventListener("click", ()=>{
          selectedIndex = idx;
          hideCtx();
          highlightSelection();
          updateDetails(selectedItem());
        });
        row.addEventListener("dblclick", ()=>{
          selectedIndex = idx;
          hideCtx();
          highlightSelection();
          updateDetails(selectedItem());
          openSelected();
        });
        row.addEventListener("contextmenu", (ev)=>{
          ev.preventDefault();
          selectedIndex = idx;
          highlightSelection();
          updateDetails(selectedItem());
          showCtx(ev.clientX, ev.clientY);
        });

        frag.appendChild(row);
      } else {
        const tile = document.createElement("div");
        tile.className = "tile";

        const ext = extLower(e.name);
        const isImg = e.kind==="file" && isImageExt(ext);

        // Grid thumbs: images only (fast). video/audio still preview in details pane.
        let thumbHTML = `<div class="emoji">${iconFor(e)}</div>`;
        if(isImg) thumbHTML = `<img src="${e.url}" loading="lazy" alt="">`;

        tile.innerHTML = `
          <div class="thumb">${thumbHTML}</div>
          <div class="tilemeta">
            <b title="${e.name}">${e.name}</b>
            <span title="${e.url}">${e.url}</span>
          </div>
        `;

        tile.addEventListener("click", ()=>{
          selectedIndex = idx;
          hideCtx();
          highlightSelection();
          updateDetails(selectedItem());
        });
        tile.addEventListener("dblclick", ()=>{
          selectedIndex = idx;
          hideCtx();
          highlightSelection();
          updateDetails(selectedItem());
          openSelected();
        });
        tile.addEventListener("contextmenu", (ev)=>{
          ev.preventDefault();
          selectedIndex = idx;
          highlightSelection();
          updateDetails(selectedItem());
          showCtx(ev.clientX, ev.clientY);
        });

        frag.appendChild(tile);
      }
    }

    rowsEl.appendChild(frag);

    if(first){
      if(selectedIndex < 0 && renderPool.length > 0) selectedIndex = 0;
      highlightSelection();
      updateDetails(selectedItem());
    } else {
      highlightSelection();
    }

    renderCount = target;
    loadMoreEl.style.display = (renderCount < renderPool.length) ? "block" : "none";
    isRendering = false;
  }

  function showCtx(x,y){
    ctxMenu.style.display = "block";
    const pad=8;
    const w=ctxMenu.offsetWidth, h=ctxMenu.offsetHeight;
    ctxMenu.style.left = Math.max(pad, Math.min(x, innerWidth-w-pad)) + "px";
    ctxMenu.style.top  = Math.max(pad, Math.min(y, innerHeight-h-pad)) + "px";
    ctxOpen.disabled = !selectedItem();
  }
  function hideCtx(){ ctxMenu.style.display = "none"; }
  ctxOpen.onclick = ()=>{ hideCtx(); openSelected(); };
  document.addEventListener("click", (ev)=>{ if(!ev.target.closest(".ctx")) hideCtx(); });
  window.addEventListener("resize", hideCtx);

  // ===== Lazy loading: scroll to load more =====
  rowsEl.addEventListener("scroll", ()=>{
    const nearBottom = rowsEl.scrollTop + rowsEl.clientHeight >= rowsEl.scrollHeight - 240;
    if(nearBottom && renderCount < renderPool.length) renderNextBatch(false);
  });

  // ===== Keyboard navigation =====
  rowsEl.addEventListener("keydown", (ev)=>{
    if(renderPool.length === 0) return;
    if(ev.key === "ArrowDown"){
      ev.preventDefault();
      selectedIndex = Math.min(renderPool.length-1, selectedIndex + 1);
      while(renderCount <= selectedIndex && renderCount < renderPool.length) renderNextBatch(false);
      highlightSelection();
      updateDetails(selectedItem());
    } else if(ev.key === "ArrowUp"){
      ev.preventDefault();
      selectedIndex = Math.max(0, selectedIndex - 1);
      highlightSelection();
      updateDetails(selectedItem());
    } else if(ev.key === "Enter"){
      ev.preventDefault();
      openSelected();
    }
  });

  // ===== Buttons =====
  openBtn.onclick = openSelected;
  refreshBtn.onclick = load;

  upBtn.onclick = ()=>{
    const p = currentPath();
    if(!p) return;
    const parts = p.split("/").filter(Boolean);
    parts.pop();
    setPath(parts.join("/"));
  };

  // Back/Forward use browser history
  backBtn.onclick = ()=> history.back();
  fwdBtn.onclick = ()=> history.forward();

  // ===== Search =====
  searchBox.addEventListener("input", ()=> renderRows(true));

  // ===== View toggle =====
  listViewBtn.onclick = ()=> setViewMode("list");
  gridViewBtn.onclick = ()=> setViewMode("grid");

  function setViewMode(mode){
    setViewModeInternal(mode);
  }
  function setViewModeInternal(mode){
    VIEW_MODE = mode;
    localStorage.setItem("ND_VIEW", mode);
    listViewBtn.classList.toggle("active", mode === "list");
    gridViewBtn.classList.toggle("active", mode === "grid");
    listHead.style.display = (mode === "list") ? "grid" : "none";
    rowsEl.classList.toggle("grid", mode === "grid");
    renderRows(true);
  }

  // ===== Lock / Logout (client-side) =====
  async function sha256Hex(str){
    const data = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function showLock(mode){
    // mode: "setup" | "lock"
    lock.style.display = "flex";
    lockMsg.textContent = "";
    lockPass.value = "";
    lockPass.focus();

    if(mode === "setup"){
      lockHint.textContent = "Set a lock password (this device only)";
      unlockBtn.textContent = "Set";
    } else {
      lockHint.textContent = "Enter to unlock";
      unlockBtn.textContent = "Unlock";
    }
  }

  async function handleUnlock(){
    const pass = lockPass.value || "";
    if(pass.length < 1){
      lockMsg.textContent = "Enter a password.";
      return;
    }

    if(!lockHash){
      // First-time setup
      lockHash = await sha256Hex(pass);
      localStorage.setItem(LOCK_KEY, lockHash);
      lock.style.display = "none";
      subtitle.textContent = "Ready";
      return;
    }

    const h = await sha256Hex(pass);
    if(h === lockHash){
      lock.style.display = "none";
      subtitle.textContent = "Ready";
    } else {
      lockMsg.textContent = "Wrong password.";
      lockPass.select();
    }
  }

  unlockBtn.onclick = handleUnlock;
  lockPass.addEventListener("keydown", (e)=>{ if(e.key === "Enter") handleUnlock(); });

  logoutBtn.onclick = ()=>{
    // "Logout" = lock the UI (client-side)
    showLock("lock");
  };

  // ===== Load =====
  window.addEventListener("popstate", load);

  async function load(){
    hideCtx();
    net.textContent = "Loading...";
    sbRight.textContent = "Loading...";
    selectedIndex = -1;

    const p = currentPath();
    buildCrumbs(p);
    renderPlaces();

    try{
      INDEX = await loadIndex();
      items = nodeChildrenForPath(p);
      renderRows(true);
      net.textContent = "OK";
      sbRight.textContent = "Ready";
    } catch(e){
      items = [];
      renderRows(true);
      net.textContent = "Error";
      sbRight.textContent = String(e);
    }
  }

  // Init view
  setViewModeInternal(VIEW_MODE);

  // Init lock: if no lockHash set, prompt to set one
  if(!lockHash){
    showLock("setup");
  } else {
    // Optional: start locked every time
    // showLock("lock");
  }

  load();
</script>
</body>
</html>
